<ng-container *ngIf="showHeader">
  <div class="page-header">
    <ng-container *ngIf="!!addBtnTitle()">
      <div class="button-container">
        <h2 class="page-title">{{ title() }}</h2>
        <button *ngFor="let button of buttons" mat-flat-button (click)="onButtonClick(button.action)"
          [ngClass]="button.class" matTooltip="{{ button.tooltip }}">
          <i [ngClass]="button.icon" style="font-size: 18px;"></i>
          &nbsp; {{ button.label }}
        </button>

      </div>
    </ng-container>
  </div>

  <div class="search-filter-container">
    <div class="search-box-container" [ngStyle]="{
         'width': filterActions.length === 0 ? '100%' : 'auto',
         'margin-right': filterActions.length === 0 ? '0' : '10px' 
       }">
      <mat-form-field appearance="outline" class="search-box">
        <mat-label>Search</mat-label>
        <input matInput [(ngModel)]="searchTerm" (keyup)="applyFilter()" />
      </mat-form-field>
    </div>

    <div class="filter-options" *ngIf="filterActions.length > 0">
      <i [matMenuTriggerFor]="filterMenu" class="fas fa-ellipsis-v vertical-dots" tabindex="0"
        aria-label="More options"></i>
      <mat-menu #filterMenu="matMenu">
        <button mat-menu-item *ngFor="let action of filterActions" (click)="onActionClick(action.action)">
          <i class="{{ action.iconClass }}"></i>
          <span>&nbsp;{{ action.label }}</span>
        </button>
      </mat-menu>
    </div>
  </div>

</ng-container>

<div class="mat-elevation-z8">
  <!-- Desktop/tablet view -->
  <div *ngIf="!isMobile; else mobileView" class="table-scroll">
    <table mat-table [dataSource]="dataSource" class="full-width-table" matSort>

      <!-- Dynamic columns -->
      <ng-container *ngFor="let col of columns trackBy: trackByKey" [matColumnDef]="col.key">
        <th mat-header-cell *matHeaderCellDef [style.text-align]="col.align || 'left'">
          {{ col.label }}
        </th>

        <td mat-cell *matCellDef="let row" [style.text-align]="col.align || 'left'" [ngClass]="getRowClass(row)">
          <ng-container *ngIf="!isEditing(row); else editField">
            <ng-container *ngIf="col.type === 'checkbox' && !col.isHidden; else defaultView">
              <mat-checkbox (change)="onFieldChange(row, col.key, $event.checked)" [checked]="row[col.key]">
              </mat-checkbox>
            </ng-container>
            <ng-template #defaultView>
              <ng-container *ngIf=" row.isEditing && col.type === 'textbox'; else noTextbox">
                <input [appNumberOnly]="true" [(ngModel)]="row[col.key]" class="custom-input" maxlength="8" />
              </ng-container>
              <ng-template #noTextbox>
                <span [ngClass]="getCellClasses(col, row)">
                  {{ col.pipe === 'date' ? (row[col.key] | date: 'dd-MM-yyyy') : row[col.key] }}
                </span>
              </ng-template>
            </ng-template>
          </ng-container>

          <ng-template #editField>
            <ng-container *ngIf="col.type === 'checkbox' && col.isHidden; else editSwitch">
              <mat-checkbox [(ngModel)]="editedRow[col.key]"></mat-checkbox>
            </ng-container>
            <ng-template #editSwitch>
              <ng-container *ngIf="row.isEditing && col.type === 'textbox'; else readOnlyView">
                <input [appNumberOnly]="true" [(ngModel)]="editedRow[col.key]" class="custom-input" maxlength="8" />
              </ng-container>
              <ng-template #readOnlyView>
                <span class="non-editable">
                  {{ col.pipe === 'date' ? (editedRow[col.key] | date: 'dd-MM-yyyy') : editedRow[col.key] }}
                </span>
              </ng-template>
            </ng-template>
          </ng-template>
        </td>

      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef style="text-align: center;">Actions</th>
        <td mat-cell *matCellDef="let row" style="text-align: center;">
          <ng-container *ngFor="let btn of actions">
            <ng-container *ngIf="btn.condition?.(row)">
              <button mat-icon-button (click)="actionClick.emit({ row, action: btn.action })"
                [matTooltip]="btn.tooltip">
                <i class="{{ btn.iconClass }}" [ngStyle]="{
              'font-size.px': 15,
              color: btn.color,
              cursor: 'pointer'
            }"></i>
              </button>
            </ng-container>
          </ng-container>
        </td>
      </ng-container>


      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>

  <!-- Mobile view -->
  <ng-template #mobileView>
    <div class="mobile-card" *ngFor="let row of paginatedMobileData; let i = index">
      <mat-card class="mobile-mat-card" [ngStyle]="{
        'background-color': getCardColor(i),
        'border-left': '8px solid ' + getOppositeColor(getCardColor(i)),
        'color': '#fff'
      }">
        <mat-card-content>
          <div class="mobile-field" *ngFor="let col of columns">
            <label>{{ col.label }}</label>
            <div class="field-value">

              <!-- View Mode -->
              <ng-container *ngIf="!isEditing(row)">
                {{ col.pipe === 'date' ? (row[col.key] | date: 'dd-MM-yyyy') : row[col.key] }}
              </ng-container>

              <!-- Edit Mode -->
              <ng-container *ngIf="isEditing(row)">
                <ng-container [ngSwitch]="col.type">
                  <!-- Checkbox -->
                  <ng-container *ngSwitchCase="'checkbox'">
                    <mat-checkbox [(ngModel)]="row[col.key]"></mat-checkbox>
                  </ng-container>

                  <!-- Textbox -->
                  <ng-container *ngSwitchCase="'textbox'">
                    <input [(ngModel)]="row[col.key]" class="custom-input" maxlength="8" />
                  </ng-container>

                  <!-- Default Fallback -->
                  <ng-container *ngSwitchDefault>
                    {{ col.pipe === 'date' ? (row[col.key] | date: 'dd-MM-yyyy') : row[col.key] }}
                  </ng-container>

                </ng-container>
              </ng-container>

            </div>
          </div>


          <div class="mobile-actions">
            <ng-container *ngFor="let btn of actions">
              <ng-container *ngIf="btn.condition?.(row)">
                <button mat-icon-button (click)="startEdit(row); actionClick.emit({ row, action: btn.action })"
                  [matTooltip]="btn.tooltip">
                  <i class="{{ btn.iconClass }}" [ngStyle]="{
                    'font-size.px': 15,
                    color: btn.color,
                    cursor: 'pointer'
                  }"></i>
                </button>
              </ng-container>
            </ng-container>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-paginator [length]="filteredData.length" [pageSize]="pageSize" [pageIndex]="pageIndex" [pageSizeOptions]="[10]"
      showFirstLastButtons (page)="onPageChange($event)">
    </mat-paginator>
  </ng-template>

  <mat-paginator *ngIf="!isMobile && dataSource.data?.length" [length]="dataSource.filteredData.length"
    [pageSize]="pageSize" [pageSizeOptions]="[10, 20, 30]" showFirstLastButtons (page)="onPageChange($event)">
  </mat-paginator>
</div>